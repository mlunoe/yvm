set -e

program="${0##*/}"

current_path="${PATH:-}"
yvm_dir="${YVM_DIR:-}"

if [ $current_path = *.yvm/versions/v* ]; then
    yarn_version="$(yarn --version)"
    yarn_version_base_directory="${yvm_dir}/versions/v${yarn_version}/"
    yarn_directory="${yarn_version_base_directory}bin/"
    exec -a "$yarn_directory" "$program" "$@"
    return
fi

if [ "$program" = "yarn" ]; then
    yarn_version="${LAST_USED_YARN_VERSION:-}"
    if [ -e .yvmrc ]; then
        yarn_version="`cat .yvmrc`"
    else
        if [ -z "$yarn_version" ]; then
            echo 'No .yvmrc file found here and no default version of yarn set'
            echo 'Please use the command "yvm use <version>" or install a version using "yvm install <version>"'
            return
        fi
    fi

    yarn_version_base_directory="${yvm_dir}/versions/v${yarn_version}/"

    if [ ! -d "${yarn_version_base_directory}" ]; then
        echo "The specified yarn version ${yarn_version} is not installed"
        echo 'Install it using "yvm install <version>"'
        return
    fi

    yarn_directory="${yarn_version_base_directory}bin/"
    PATH="$yarn_directory":$PATH

    exec -a "$yarn_directory" "$program" "$@"
fi